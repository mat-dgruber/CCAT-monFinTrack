<div class="mb-8">
  <div
    class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6"
  >
    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
      Vis√£o Geral
    </h2>
    <div class="flex gap-2">
      <!-- AI Report Button moved to FAB -->
      <app-month-selector></app-month-selector>
    </div>
  </div>

  @if (loading()) {
  <!-- Skeleton Layout -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"
    >
      <p-skeleton width="100px" styleClass="mb-2"></p-skeleton>
      <p-skeleton width="150px" height="2rem"></p-skeleton>
    </div>
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"
    >
      <p-skeleton width="100px" styleClass="mb-2"></p-skeleton>
      <p-skeleton width="150px" height="2rem"></p-skeleton>
    </div>
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"
    >
      <p-skeleton width="100px" styleClass="mb-2"></p-skeleton>
      <p-skeleton width="150px" height="2rem"></p-skeleton>
    </div>
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"
    >
      <p-skeleton width="100px" styleClass="mb-2"></p-skeleton>
      <p-skeleton width="150px" height="2rem"></p-skeleton>
    </div>
  </div>

  <div class="mb-8">
    <p-skeleton height="200px" borderRadius="12px"></p-skeleton>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 h-[400px]"
    >
      <p-skeleton width="200px" styleClass="mb-4"></p-skeleton>
      <div class="flex justify-center items-center h-full">
        <p-skeleton shape="circle" size="200px"></p-skeleton>
      </div>
    </div>
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 h-[400px]"
    >
      <p-skeleton width="200px" styleClass="mb-4"></p-skeleton>
      <p-skeleton height="300px"></p-skeleton>
    </div>
  </div>

  <div class="mb-8">
    <p-skeleton height="200px" borderRadius="12px"></p-skeleton>
  </div>

  <div>
    <p-skeleton height="300px" borderRadius="12px"></p-skeleton>
  </div>

  } @else if (summary(); as data) {
  <!-- 1. Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"
    >
      <div class="text-gray-500 dark:text-gray-400 font-medium mb-2">
        Saldo Total
      </div>
      <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">
        {{ data.total_balance | currency : "BRL" }}
      </div>
    </div>

    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"
    >
      <div class="text-gray-500 dark:text-gray-400 font-medium mb-2">
        Receitas (Geral)
      </div>
      <div class="text-3xl font-bold text-green-500 dark:text-green-400">
        + {{ data.income_month | currency : "BRL" }}
      </div>
    </div>

    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700"
    >
      <div class="text-gray-500 dark:text-gray-400 font-medium mb-2">
        Despesas (Geral)
      </div>
      <div class="text-3xl font-bold text-red-500 dark:text-red-400">
        - {{ data.expense_month | currency : "BRL" }}
      </div>
    </div>

    @if (subscriptionService.canAccess('cost_of_living')) {
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:shadow-md transition-shadow"
      routerLink="/cost-of-living"
    >
      <div class="text-gray-500 dark:text-gray-400 font-medium mb-2">
        Custo de Vida (M√©dio)
      </div>
      <div class="text-3xl font-bold text-purple-600 dark:text-purple-400">
        {{ costOfLiving() | currency : "BRL" }}
      </div>
      <p class="text-xs text-gray-400 mt-2">Clique para ver detalhes</p>
    </div>
    } @else {
      <!-- Placeholder for Free Users to upsell? Or just hide. User asked to remove. -->
      <!-- Keeping grid structure by adding a placeholder or just letting grid flow. 
           If we remove it, the grid might have a hole if it's strictly 4 cols.
           Let's use a "Upgrade to Pro" placeholder if desired, but user said "remove".
           However, grid-cols-4 means we need 4 items or it will wrap weirdly if we want a row.
           Actually, CSS grid will just place 3 items. That's fine.
      -->
    }
  </div>

  <!-- 2. Accounts (Contas) - Above Charts -->
  <div class="mb-8">
    <app-account-manager></app-account-manager>
  </div>

  <!-- Invoices Widget -->
  @if (subscriptionService.canAccess('credit_card_mgmt')) {
  <div class="mb-8">
    <div
      class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6"
    >
      <div>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">
          Faturas Abertas
        </h2>
        <p class="text-gray-500 dark:text-gray-400">
          Acompanhe os limites e vencimentos dos seus cart√µes.
        </p>
      </div>
      <p-button
        label="Ver todas"
        icon="pi pi-arrow-right"
        styleClass="p-button-text p-button-rounded"
        routerLink="/invoices"
      ></p-button>
    </div>
    <app-invoice-dashboard [isWidget]="true"></app-invoice-dashboard>
  </div>
  }

  <!-- 3. Charts Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col"
    >
      <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
        Despesas por Categoria
      </h3>
      @if (data.expenses_by_category.length > 0) {
      <div class="w-full h-[300px] flex justify-center">
        <p-chart
          type="doughnut"
          [data]="chartData"
          [options]="chartOptions"
          class="w-full h-full"
        ></p-chart>
      </div>
      } @else {
      <div class="text-gray-400 italic mt-10 text-center">
        Sem despesas registradas para os filtros selecionados.
      </div>
      }
    </div>

    <div
      class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col"
    >
      <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">
        Evolu√ß√£o Mensal
      </h3>
      @if (data.evolution && data.evolution.length > 0) {
      <div class="w-full h-[300px] flex justify-center">
        <p-chart
          type="bar"
          [data]="evolutionChartData"
          [options]="evolutionChartOptions"
          class="w-full h-full"
        ></p-chart>
      </div>
      } @else {
      <div class="text-gray-400 italic mt-10 text-center">
        Dados insuficientes para exibir evolu√ß√£o.
      </div>
      }
    </div>
  </div>

  <!-- 4. Metas (Budgets) -->
  <div class="mb-8">
    <app-budget-manager></app-budget-manager>
  </div>

  <!-- 6. Recent Transactions (Last 7) -->
  <app-recent-transactions></app-recent-transactions>

  }

  <p-dialog
    header="Relat√≥rio Mensal IA ü§ñ"
    [(visible)]="showReportDialog"
    [modal]="true"
    [style]="{ width: '90vw', maxWidth: '600px' }"
    [draggable]="false"
    [resizable]="false"
    [dismissableMask]="true"
  >
    @if (reportLoading) {
    <div class="flex flex-col items-center justify-center p-6 text-center">
      <i class="pi pi-spin pi-spinner text-4xl mb-4 text-purple-500"></i>
      <p class="text-gray-600 dark:text-gray-300">
        Analisando suas finan√ßas... üß†
      </p>
    </div>
    } @else {
    <div
      class="prose dark:prose-invert max-w-none text-gray-800 dark:text-gray-200"
    >
      <markdown [data]="reportContent"></markdown>
    </div>
    }
  </p-dialog>
  
  <!-- AI Report FAB -->
  <div class="fixed bottom-6 left-6 lg:left-72 z-50 flex flex-col gap-2">
    <!-- Pro Button -->
    <button
        *ngIf="subscriptionService.canAccess('monthly_report')"
        (click)="generateReport()"
        class="group relative flex items-center justify-center gap-2 px-4 h-14 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-full shadow-lg hover:shadow-2xl hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-purple-300 dark:focus:ring-purple-900"
        pTooltip="Gerar Resumo IA"
        tooltipPosition="right"
    >
        <i class="pi pi-sparkles text-xl text-white animate-pulse"></i>
        <span class="text-white font-bold whitespace-nowrap">Relat√≥rio IA</span>
    </button>

    <!-- Locked Button -->
    <button
        *ngIf="!subscriptionService.canAccess('monthly_report')"
        class="flex items-center justify-center w-14 h-14 bg-gray-200 dark:bg-slate-700 rounded-full shadow-md cursor-not-allowed opacity-75"
        pTooltip="Resumo IA (Pro)"
        tooltipPosition="right"
    >
        <i class="pi pi-lock text-xl text-gray-500 dark:text-gray-400"></i>
    </button>
  </div>
</div>
