<div class="max-w-[1600px] mx-auto p-4 lg:p-6">
  <!-- Header -->
  <div class="flex items-center gap-4 mb-8">
    <h1 class="text-3xl font-bold text-color m-0">Configurações</h1>
  </div>

  <!-- Organic Grid Layout -->
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 items-start grid-flow-row-dense">

    <!-- 1. PROFILE (Standard) -->
    <div class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6 h-full flex flex-col col-span-1">
      <h2 class="text-xl font-semibold text-color mb-6">Meu Perfil</h2>

      <div class="flex flex-col gap-6">
        <!-- Profile Picture -->
        <div class="flex items-center gap-4">
          <div class="relative">
            <img
              [src]="profileImageUrl()"
              alt="Profile"
              class="w-24 h-24 rounded-full object-cover border-4 border-surface-ground"
              onerror="this.src='assets/default-avatar.png'"
            />
          </div>
          <div class="flex flex-col gap-2">
            <p-fileUpload
              mode="basic"
              chooseLabel="Alterar Foto"
              name="avatar"
              accept="image/*"
              maxFileSize="1000000"
              [auto]="true"
              customUpload="true"
              (uploadHandler)="onUpload($event)"
              styleClass="p-button-outlined p-button-secondary p-button-sm"
            ></p-fileUpload>
            <small class="text-secondary">Max 1MB. JPG/PNG.</small>
          </div>
        </div>

        <!-- Full Name -->
        <div class="flex flex-col gap-2">
          <label for="displayName" class="font-medium text-secondary"
            >Nome Completo</label
          >
          <input
            pInputText
            id="displayName"
            [(ngModel)]="displayName"
            class="w-full"
          />
        </div>

        <!-- Update Button -->
        <div class="mt-auto pt-2">
          <p-button
            label="Salvar Alterações"
            styleClass="w-full bg-primary border-primary hover:bg-opacity-90 text-primary-text"
            (onClick)="updateProfile()"
          >
          </p-button>
        </div>
      </div>
    </div>

    <!-- 2. SECURITY CENTER (Wide - Merged Email, MFA, Danger) -->
    <div class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6 h-full flex flex-col col-span-1 md:col-span-2">
       <div class="flex items-center gap-3 mb-6">
           <i class="pi pi-shield text-2xl text-primary"></i>
           <h2 class="text-xl font-semibold text-color m-0">Central de Segurança</h2>
       </div>
       
       <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8 mb-8">
           <!-- Col 1: Access -->
           <div class="flex flex-col gap-6">
               <h3 class="text-base font-bold text-color uppercase tracking-wider text-xs border-b border-surface-border pb-2 m-0">Credenciais de Acesso</h3>
               
               <!-- Email -->
               <div class="flex flex-col gap-2">
                   <div class="flex justify-between items-center">
                        <span class="font-medium text-secondary">Email Cadastrado</span>
                   </div>
                   <div class="flex items-center gap-3 p-3 bg-surface-ground rounded-lg border border-surface-border">
                     <i class="pi pi-envelope text-secondary"></i>
                     <span class="text-color font-medium break-all flex-1">{{ email() }}</span>
                     @if (auth.currentUser()?.emailVerified) {
                        <i class="pi pi-check-circle text-green-500" pTooltip="Verificado"></i>
                     } @else {
                        <i class="pi pi-exclamation-circle text-orange-500 cursor-pointer" (click)="verifyEmail()" pTooltip="Não verificado. Clique para enviar email."></i>
                     }
                   </div>
               </div>

               <!-- Password -->
               <div class="flex justify-between items-center gap-4 p-3 bg-surface-ground rounded-lg border border-surface-border">
                   <div class="flex items-center gap-3">
                       <i class="pi pi-lock text-secondary"></i>
                       <span class="font-medium text-secondary">Senha de Acesso</span>
                   </div>
                   <p-button
                     label="Alterar"
                     [text]="true"
                     size="small"
                     (onClick)="sendPasswordReset()"
                   >
                   </p-button>
               </div>
           </div>

           <!-- Col 2: MFA -->
           <div class="flex flex-col gap-6">
               <h3 class="text-base font-bold text-color uppercase tracking-wider text-xs border-b border-surface-border pb-2 m-0">Autenticação em Duas Etapas (MFA)</h3>
               
               <div class="flex flex-col gap-4">
                   <div class="flex items-start gap-4">
                        <div class="mt-1">
                            @if (mfaEnabled()) {
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                    <i class="pi pi-check text-xl"></i>
                                </div>
                            } @else {
                                <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                                    <i class="pi pi-shield text-xl"></i>
                                </div>
                            }
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-color">Status de Proteção</span>
                                @if (mfaEnabled()) {
                                    <p-tag value="Ativado" severity="success"></p-tag>
                                } @else {
                                    <p-tag value="Recomendado" severity="warn"></p-tag>
                                }
                            </div>
                            <p class="text-sm text-secondary m-0 line-clamp-2">
                                Proteja sua conta solicitando um código do seu aplicativo autenticador ao fazer login.
                            </p>
                        </div>
                   </div>

                   @if (!mfaEnabled()) {
                    <p-button
                        label="Configurar Agora"
                        styleClass="w-full p-button-secondary"
                        (onClick)="startMfaSetup()"
                    ></p-button>
                   } @else {
                    <p-button
                        label="Desativar Proteção"
                        styleClass="w-full p-button-outlined p-button-danger"
                        (onClick)="disableMFA()"
                    ></p-button>
                   }
               </div>
           </div>
       </div>

       <!-- Danger Zone (Bottom) -->
       <div class="mt-auto pt-6 border-t border-surface-border">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <span class="text-sm text-secondary font-medium">Zona de Perigo</span>
                <div class="flex gap-2 w-full sm:w-auto">
                    <p-button
                    label="Limpar Dados"
                    styleClass="p-button-text p-button-secondary p-button-sm flex-1 sm:flex-none"
                    icon="pi pi-trash"
                    (onClick)="onResetAccount()"
                    >
                    </p-button>
                    <p-button
                    label="Excluir Conta"
                    styleClass="p-button-text p-button-danger p-button-sm flex-1 sm:flex-none"
                    icon="pi pi-times"
                    (onClick)="confirmDelete()"
                    >
                    </p-button>
                </div>
            </div>
       </div>
    </div>

    <!-- 3. APP PREFERENCES (Merged General + System) -->
    <div class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6 h-full flex flex-col col-span-1">
      <h2 class="text-xl font-semibold text-color mb-6">Sistema e Aparência</h2>

      <div class="flex flex-col gap-5">
        <!-- Theme -->
        <div class="field">
          <label class="font-medium text-secondary block mb-2">Tema da Interface</label>
          <p-select
            [options]="themeOptions"
            [(ngModel)]="selectedTheme"
            (onChange)="onThemeChange()"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
            appendTo="body"
          ></p-select>
        </div>

        <!-- Wake Lock -->
        <div class="flex justify-between items-center py-2 border-y border-surface-border">
          <div class="flex flex-col">
            <span class="font-medium text-color">Manter Tela Ligada</span>
            <span class="text-xs text-secondary">Evita bloqueio automático.</span>
          </div>
          <p-toggleswitch
            [ngModel]="wakeLockEnabled()"
            (ngModelChange)="toggleWakeLock()"
          ></p-toggleswitch>
        </div>

        <!-- Install App -->
        @if (pwaService.isInstallable) {
        <div class="flex justify-between items-center">
          <div class="flex flex-col">
            <span class="font-medium text-color">Instalar App</span>
            <span class="text-xs text-secondary">Versão desktop/mobile.</span>
          </div>
          <p-button
            icon="pi pi-download"
            [rounded]="true"
            [text]="true"
            (onClick)="installApp()"
            pTooltip="Instalar"
          ></p-button>
        </div>
        }

        <!-- Subscription Mode (Test) -->
        <div class="mt-auto pt-4">
          <label class="font-medium text-secondary block mb-2 text-xs uppercase tracking-wider">Ambiente de Teste (Tier)</label>
          <div class="flex items-center gap-2">
            <p-select
              [options]="tierOptions"
              [(ngModel)]="selectedTier"
              (onChange)="onTierChange($event)"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
              appendTo="body"
            ></p-select>
          </div>
        </div>
      </div>
    </div>

    <!-- 4. AI INTEGRATION -->
    <div class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6 h-full flex flex-col col-span-1">
      <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-color m-0">Uso de IA</h2>
          <p-tag [value]="aiLimits()?.tier" severity="info" styleClass="uppercase"></p-tag>
      </div>
      
      <div class="flex flex-col gap-6 flex-1">
          @if (aiLimits()) {
              <div class="flex flex-col gap-5">
                  <!-- Classify Limit -->
                  <div>
                      <div class="flex justify-between mb-2">
                          <span class="font-medium text-sm">Scanner</span>
                          <span class="text-xs text-secondary">{{ aiLimits().classify.used }} / {{ aiLimits().classify.limit }}</span>
                      </div>
                      <p-progressBar [value]="aiLimits().classify.limit > 0 ? (aiLimits().classify.used / aiLimits().classify.limit) * 100 : 0" [showValue]="false" styleClass="h-2"></p-progressBar>
                  </div>

                  <!-- Chat Limit -->
                  <div>
                       <div class="flex justify-between mb-2">
                          <span class="font-medium text-sm">Chat</span>
                          <span class="text-xs text-secondary">{{ aiLimits().chat.used }} / {{ aiLimits().chat.limit }}</span>
                      </div>
                      <p-progressBar [value]="aiLimits().chat.limit > 0 ? (aiLimits().chat.used / aiLimits().chat.limit) * 100 : 0" [showValue]="false" styleClass="h-2"></p-progressBar>
                  </div>
              </div>
              
              <div class="mt-auto p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg flex gap-3 text-sm text-blue-800 dark:text-blue-200">
                  <i class="pi pi-sparkles mt-1"></i>
                  <p class="m-0 leading-tight">Seu plano permite acesso a recursos avançados de análise.</p>
              </div>
          } @else {
              <div class="flex flex-col items-center justify-center h-40 gap-3">
                  <p-progressSpinner styleClass="w-2rem h-2rem"></p-progressSpinner>
                  <span class="text-secondary text-sm">Carregando limites...</span>
              </div>
          }
      </div>
    </div>

    <!-- 5. TITHES -->
    <div class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6 h-full flex flex-col col-span-1">
      <h2 class="text-xl font-semibold text-color mb-6">Dízimos</h2>

      <div class="flex flex-col gap-6">
        <div class="flex justify-between items-center gap-4 bg-surface-ground p-3 rounded-lg border border-surface-border">
          <span class="font-medium text-color">Habilitar Recurso</span>
          <p-toggleswitch
            [(ngModel)]="tithesEnabled"
            (ngModelChange)="onTithesChange()"
          ></p-toggleswitch>
        </div>

        @if (tithesEnabled()) {
        <div class="grid grid-cols-2 gap-3">
             <div class="flex flex-col gap-2">
                <span class="font-medium text-xs text-secondary uppercase">Dízimo</span>
                <p-inputNumber
                    [(ngModel)]="defaultTithePct"
                    (onBlur)="onTitheSettingsChange()"
                    suffix="%"
                    [min]="0"
                    [max]="100"
                    [showButtons]="true"
                    buttonLayout="horizontal"
                    inputParam="size"
                    [inputStyle]="{ width: '100%', 'text-align': 'center', 'padding': '0.5rem' }"
                    styleClass="w-full"
                ></p-inputNumber>
             </div>
             <div class="flex flex-col gap-2">
                <span class="font-medium text-xs text-secondary uppercase">Oferta</span>
                <p-inputNumber
                    [(ngModel)]="defaultOfferingPct"
                    (onBlur)="onTitheSettingsChange()"
                    suffix="%"
                    [min]="0"
                    [max]="100"
                    [showButtons]="true"
                    buttonLayout="horizontal"
                    inputParam="size"
                    [inputStyle]="{ width: '100%', 'text-align': 'center', 'padding': '0.5rem' }"
                    styleClass="w-full"
                ></p-inputNumber>
             </div>
        </div>

        <div class="flex flex-col gap-3 mt-auto">
             <div class="flex justify-between items-center text-sm">
                 <span class="text-secondary">Dízimo Automático</span>
                 <p-toggleswitch [(ngModel)]="autoApplyTithe" (ngModelChange)="onTitheSettingsChange()" styleClass="scale-75"></p-toggleswitch>
             </div>
             <div class="flex justify-between items-center text-sm">
                 <span class="text-secondary">Oferta Automática</span>
                 <p-toggleswitch [(ngModel)]="autoApplyOffering" (ngModelChange)="onTitheSettingsChange()" styleClass="scale-75"></p-toggleswitch>
             </div>
        </div>
        } @else {
            <div class="flex items-center justify-center flex-1 opacity-50">
                <i class="pi pi-heart text-4xl text-surface-border"></i>
            </div>
        }
      </div>
    </div>
  
  </div> <!-- End Grid -->
</div>

<!-- Dialogs & Toasts -->
<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<p-dialog
  header="Configurar MFA"
  [(visible)]="showMfaSetupDialog"
  [modal]="true"
  [style]="{ width: '400px' }"
  styleClass="bg-surface-card text-color"
  appendTo="body"
>
  <div class="flex flex-col items-center gap-6 py-4">
    <p class="text-center text-color">
      Escaneie o QR Code abaixo com seu aplicativo autenticador.
    </p>

    <div class="bg-white p-2 rounded-lg border border-gray-200">
      <img [src]="qrCodeUrl()" alt="QR Code" class="w-48 h-48" />
    </div>

    <div class="flex flex-col gap-2 w-full items-center">
      <p class="text-xs text-secondary text-center">
        Não consegue ler o QR Code?
      </p>
      <div
        class="flex items-center gap-2 bg-surface-ground px-3 py-2 rounded-md border border-surface-border max-w-full"
      >
        <code class="text-sm font-mono text-color break-all select-all">{{
          mfaSecret()
        }}</code>
        <button
          pButton
          icon="pi pi-copy"
          class="p-button-rounded p-button-text p-button-sm text-secondary hover:text-primary"
          (click)="copyToClipboard(mfaSecret())"
          pTooltip="Copiar código"
        ></button>
      </div>
    </div>

    <div class="flex flex-col gap-2 w-full">
      <label for="mfaToken" class="font-medium text-color"
        >Código de Verificação</label
      >
      <input
        pInputText
        id="mfaToken"
        [(ngModel)]="mfaToken"
        class="w-full text-center text-2xl tracking-[0.5em] font-mono"
        maxlength="6"
        placeholder="000000"
      />
    </div>

    <div class="flex justify-end gap-2 w-full mt-2">
      <p-button
        label="Cancelar"
        styleClass="p-button-text"
        (onClick)="showMfaSetupDialog.set(false)"
      ></p-button>
      <p-button
        label="Verificar e Ativar"
        (onClick)="confirmEnableMFA()"
        [disabled]="mfaToken().length !== 6"
      ></p-button>
    </div>
  </div>
</p-dialog>
