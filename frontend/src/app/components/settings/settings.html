<div class="max-w-4xl mx-auto p-4 lg:p-6 space-y-6">
  <!-- Header -->
  <div class="flex items-center gap-4 mb-8">
    <h1 class="text-3xl font-bold text-color m-0">Configurações</h1>
  </div>

  <!-- General Preferences Section -->
  <div
    class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6"
  >
    <h2 class="text-xl font-semibold text-color mb-6">Preferências Gerais</h2>

    <div class="flex flex-col gap-4">
      <!-- Theme -->
      <div class="flex flex-col gap-2">
        <label class="font-medium text-secondary">Tema</label>
        <p-select
          [options]="themeOptions"
          [(ngModel)]="selectedTheme"
          (onChange)="onThemeChange()"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full max-w-md"
          appendTo="body"
        ></p-select>
      </div>
    </div>
  </div>

  <!-- Tithes & Offerings Section -->
  <div
    class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6"
  >
    <h2 class="text-xl font-semibold text-color mb-6">Dízimos e Ofertas</h2>

    <div class="flex flex-col gap-6">
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary"
            >Habilitar Dízimos e Ofertas</span
          >
          <span class="text-sm text-secondary"
            >Ativa campos de dízimo e oferta nas receitas.</span
          >
        </div>
        <p-toggleswitch
          [(ngModel)]="tithesEnabled"
          (ngModelChange)="onTithesChange()"
        ></p-toggleswitch>
      </div>

      @if (tithesEnabled()) {
      <hr class="border-surface-border" />

      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary">Dízimo Padrão (%)</span>
          <span class="text-sm text-secondary"
            >Porcentagem sugerida ao criar uma receita.</span
          >
        </div>
        <p-inputNumber
          [(ngModel)]="defaultTithePct"
          (onBlur)="onTitheSettingsChange()"
          suffix="%"
          [min]="0"
          [max]="100"
          [showButtons]="true"
          buttonLayout="horizontal"
          inputParam="size"
          [inputStyle]="{ width: '5rem', 'text-align': 'center' }"
          styleClass="w-auto"
        ></p-inputNumber>
      </div>

      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary">Oferta Padrão (%)</span>
          <span class="text-sm text-secondary"
            >Porcentagem sugerida ao criar uma receita (Ex: 5%).</span
          >
        </div>
        <p-inputNumber
          [(ngModel)]="defaultOfferingPct"
          (onBlur)="onTitheSettingsChange()"
          suffix="%"
          [min]="0"
          [max]="100"
          [showButtons]="true"
          buttonLayout="horizontal"
          inputParam="size"
          [inputStyle]="{ width: '5rem', 'text-align': 'center' }"
          styleClass="w-auto"
        ></p-inputNumber>
      </div>

      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary"
            >Aplicar Automaticamente</span
          >
          <span class="text-sm text-secondary"
            >Marcar a opção de dízimo automaticamente em novas receitas.</span
          >
        </div>
        <p-toggleswitch
          [(ngModel)]="autoApplyTithe"
          (ngModelChange)="onTitheSettingsChange()"
        ></p-toggleswitch>
      </div>

      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary"
            >Aplicar Oferta Automaticamente</span
          >
          <span class="text-sm text-secondary"
            >Marcar a opção de oferta automaticamente em novas receitas.</span
          >
        </div>
        <p-toggleswitch
          [(ngModel)]="autoApplyOffering"
          (ngModelChange)="onTitheSettingsChange()"
        ></p-toggleswitch>
      </div>
      }
    </div>
  </div>

  <!-- App & System Section -->
  <div
    class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6"
  >
    <h2 class="text-xl font-semibold text-color mb-6">Aplicativo & Sistema</h2>

    <div class="flex flex-col gap-6">
      <!-- Wake Lock -->
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary">Manter Tela Ligada</span>
          <span class="text-sm text-secondary"
            >Impede que a tela desligue enquanto o app estiver aberto.</span
          >
        </div>
        <p-toggleswitch
          [ngModel]="wakeLockEnabled()"
          (ngModelChange)="toggleWakeLock()"
        ></p-toggleswitch>
      </div>

      <!-- Install App -->
      @if (pwaService.isInstallable) {
      <hr class="border-surface-border" />
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary">Instalar Aplicativo</span>
          <span class="text-sm text-secondary"
            >Instale o MonFinTrack para uma melhor experiência.</span
          >
        </div>
        <p-button
          label="Instalar"
          icon="pi pi-download"
          styleClass="p-button-outlined"
          (onClick)="installApp()"
        ></p-button>
      </div>
      }
    </div>
  </div>

  <!-- Profile Section -->
  <div
    class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6"
  >
    <h2 class="text-xl font-semibold text-color mb-6">Perfil</h2>

    <div class="flex flex-col gap-6">
      <!-- Profile Picture -->
      <div class="flex items-center gap-4">
        <div class="relative">
          <img
            [src]="profileImageUrl()"
            alt="Profile"
            class="w-24 h-24 rounded-full object-cover border-4 border-surface-ground"
            onerror="this.src='assets/default-avatar.png'"
          />
        </div>
        <div class="flex flex-col gap-2">
          <p-fileUpload
            mode="basic"
            chooseLabel="Alterar Foto"
            name="avatar"
            accept="image/*"
            maxFileSize="1000000"
            [auto]="true"
            customUpload="true"
            (uploadHandler)="onUpload($event)"
            styleClass="p-button-outlined p-button-secondary p-button-sm"
          ></p-fileUpload>
          <small class="text-secondary">Max 1MB. JPG/PNG.</small>
        </div>
      </div>

      <!-- Full Name -->
      <div class="flex flex-col gap-2">
        <label for="displayName" class="font-medium text-secondary"
          >Nome Completo</label
        >
        <input
          pInputText
          id="displayName"
          [(ngModel)]="displayName"
          class="w-full"
        />
      </div>

      <!-- Update Button -->
      <div class="mt-2">
        <p-button
          label="Atualizar Perfil"
          styleClass="w-full bg-primary border-primary hover:bg-opacity-90 text-primary-text"
          (onClick)="updateProfile()"
        >
        </p-button>
      </div>
    </div>
  </div>

  <!-- Email & Password Section -->
  <div
    class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6"
  >
    <h2 class="text-xl font-semibold text-color mb-6">Email e Segurança</h2>

    <div class="flex flex-col gap-6">
      <!-- Email -->
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary">Email</span>
          <div class="flex items-center gap-2 flex-wrap">
            <span class="text-color font-medium">{{ email() }}</span>
            @if (auth.currentUser()?.emailVerified) {
            <p-tag
              value="Verificado"
              severity="success"
              styleClass="text-xs"
            ></p-tag>
            } @if (!auth.currentUser()?.emailVerified) {
            <p-tag
              value="Não Verificado"
              severity="warn"
              styleClass="text-xs cursor-pointer"
              (click)="verifyEmail()"
              pTooltip="Clique para enviar email de verificação"
            ></p-tag>
            }
          </div>
        </div>
        <p-button
          label="Editar email"
          styleClass="p-button-outlined p-button-secondary"
          size="small"
        ></p-button>
      </div>

      <hr class="border-surface-border" />

      <!-- Password -->
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
      >
        <div class="flex flex-col gap-1">
          <span class="font-medium text-secondary">Senha</span>
          <span class="text-sm text-secondary"
            >Alterar sua senha de acesso</span
          >
        </div>
        <p-button
          label="Alterar senha"
          styleClass="p-button-outlined p-button-secondary"
          size="small"
          (onClick)="sendPasswordReset()"
        >
        </p-button>
      </div>
    </div>
  </div>

  <!-- Multi-Factor Authentication -->
  <div
    class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6"
  >
    <h2 class="text-xl font-semibold text-color mb-6">
      Autenticação de Dois Fatores (MFA)
    </h2>

    <div
      class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
    >
      <div class="flex flex-col gap-1">
        <div class="flex items-center gap-2">
          <span class="font-medium text-secondary">Status do MFA</span>
          @if (mfaEnabled()) {
          <p-tag
            value="Ativado"
            severity="success"
            styleClass="text-xs"
          ></p-tag>
          } @if (!mfaEnabled()) {
          <p-tag
            value="Desativado"
            severity="warn"
            styleClass="text-xs bg-orange-100 text-orange-800"
          ></p-tag>
          }
        </div>
        <span class="text-sm text-secondary"
          >Proteja sua conta com uma camada extra de segurança</span
        >
      </div>

      @if (!mfaEnabled()) {
      <p-button
        label="Ativar MFA"
        styleClass="p-button-outlined p-button-secondary"
        size="small"
        (onClick)="startMfaSetup()"
      ></p-button>
      } @if (mfaEnabled()) {
      <p-button
        label="Desativar MFA"
        styleClass="p-button-outlined p-button-danger"
        size="small"
        (onClick)="disableMFA()"
      ></p-button>
      }
    </div>
  </div>

  <p-dialog
    header="Configurar MFA"
    [(visible)]="showMfaSetupDialog"
    [modal]="true"
    [style]="{ width: '400px' }"
    styleClass="bg-surface-card text-color"
  >
    <div class="flex flex-col items-center gap-6 py-4">
      <p class="text-center text-color">
        Escaneie o QR Code abaixo com seu aplicativo autenticador (Google
        Authenticator, Authy, etc).
      </p>

      <div class="bg-white p-2 rounded-lg border border-gray-200">
        <img [src]="qrCodeUrl()" alt="QR Code" class="w-48 h-48" />
      </div>

      <div class="flex flex-col gap-2 w-full items-center">
        <p class="text-xs text-secondary text-center">
          Não consegue ler o QR Code?
        </p>
        <div
          class="flex items-center gap-2 bg-surface-ground px-3 py-2 rounded-md border border-surface-border max-w-full"
        >
          <code class="text-sm font-mono text-color break-all select-all">{{
            mfaSecret()
          }}</code>
          <button
            pButton
            icon="pi pi-copy"
            class="p-button-rounded p-button-text p-button-sm text-secondary hover:text-primary"
            (click)="copyToClipboard(mfaSecret())"
            pTooltip="Copiar código"
          ></button>
        </div>
      </div>

      <div class="flex flex-col gap-2 w-full">
        <label for="mfaToken" class="font-medium text-color"
          >Código de Verificação</label
        >
        <input
          pInputText
          id="mfaToken"
          [(ngModel)]="mfaToken"
          class="w-full text-center text-2xl tracking-[0.5em] font-mono"
          maxlength="6"
          placeholder="000000"
        />
      </div>

      <div class="flex justify-end gap-2 w-full mt-2">
        <p-button
          label="Cancelar"
          styleClass="p-button-text"
          (onClick)="showMfaSetupDialog.set(false)"
        ></p-button>
        <p-button
          label="Verificar e Ativar"
          (onClick)="confirmEnableMFA()"
          [disabled]="mfaToken().length !== 6"
        ></p-button>
      </div>
    </div>
  </p-dialog>

  <!-- Account Data -->
  <div
    class="bg-surface-card rounded-xl shadow-sm border border-surface-border p-6 border-l-4 border-l-red-500"
  >
    <h2 class="text-xl font-semibold text-color mb-6">Zona de Perigo</h2>

    <div
      class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
    >
      <div class="flex flex-col gap-1">
        <span class="font-medium text-secondary">Gerenciar Dados</span>
        <p class="text-sm text-secondary max-w-xl">
          Ações irreversíveis relacionadas à sua conta e dados.
        </p>
      </div>
      <div class="flex gap-3">
        <p-button
          label="Limpar Dados"
          styleClass="p-button-outlined p-button-secondary"
          size="small"
          (onClick)="onResetAccount()"
        >
        </p-button>
        <p-button
          label="Excluir Conta"
          styleClass="p-button-outlined p-button-danger"
          size="small"
          (onClick)="confirmDelete()"
        >
        </p-button>
      </div>
    </div>
  </div>
</div>

<p-toast></p-toast>

