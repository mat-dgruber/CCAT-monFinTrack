<p-dialog [header]="editingId() ? 'Editar Transação' : 'Nova Transação'" [modal]="true" [(visible)]="visible"
  [style]="{ width: '30rem', maxHeight: '90vh' }" [breakpoints]="{ '960px': '75vw', '640px': '95vw' }"
  [draggable]="false" [resizable]="false" [contentStyle]="{ overflowY: 'auto' }">
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex flex-col gap-5 pt-4">
    <div class="flex justify-center flex-col gap-3">
      <div class="flex justify-center">
        <p-selectButton [options]="typeOptions" formControlName="type" optionLabel="label" optionValue="value">
        </p-selectButton>
      </div>

      <div class="flex justify-center">
        <p-selectButton [options]="modeOptions" formControlName="mode" optionLabel="label" optionValue="value">
        </p-selectButton>
      </div>
    </div>

    <!-- Campos de Recorrência -->
    @if (form.get('mode')?.value === 'recurrence') {
    <div
      class="flex flex-col gap-3 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-slate-900">
      <h3 class="font-bold text-sm text-gray-600 dark:text-gray-300">
        Configuração da Recorrência
      </h3>

      <div class="flex flex-col gap-2">
        <label class="font-semibold text-gray-700 dark:text-gray-200">Periodicidade</label>
        <p-select [options]="periodicityOptions" formControlName="recurrence_periodicity" optionLabel="label"
          optionValue="value" [style]="{ width: '100%' }"></p-select>
      </div>

      <div class="flex items-center gap-2">
        <p-checkbox formControlName="recurrence_auto_pay" [binary]="true" inputId="auto_pay"></p-checkbox>
        <label for="auto_pay" class="cursor-pointer dark:text-gray-200">Pagamento Automático</label>
      </div>

      <div class="flex items-center gap-2">
        <p-checkbox formControlName="recurrence_create_first" [binary]="true" inputId="create_first"></p-checkbox>
        <label for="create_first" class="cursor-pointer dark:text-gray-200">Criar primeira transação agora</label>
      </div>
    </div>
    }

    <!-- Campos de Parcelamento -->
    @if (form.get('mode')?.value === 'installments') {
    <div
      class="flex flex-col gap-3 p-3 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-slate-900">
      <h3 class="font-bold text-sm text-gray-600 dark:text-gray-300">
        Configuração do Parcelamento
      </h3>

      <div class="flex flex-col gap-2">
        <label class="font-semibold text-gray-700 dark:text-gray-200">Número de Parcelas</label>
        <p-inputNumber formControlName="total_installments" [min]="2" [max]="120" [showButtons]="true"
          buttonLayout="horizontal" inputId="installments" decrementButtonClass="p-button-secondary"
          incrementButtonClass="p-button-secondary" incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus"
          [style]="{ width: '100%' }" inputStyleClass="w-full text-center"></p-inputNumber>
      </div>
    </div>
    }

    <div class="flex flex-col gap-2">
      <label for="title" class="font-semibold text-gray-700 dark:text-gray-200">Título</label>
      <input pInputText id="title" formControlName="title" placeholder="Ex: Mercado, Uber..." class="w-full" />
    </div>

    <div class="flex flex-col gap-2">
      <label for="desc" class="font-semibold text-gray-700 dark:text-gray-200">Descrição (Opcional)</label>
      <textarea pTextarea id="desc" formControlName="description" rows="3" class="w-full p-inputtext" style="resize: none;" placeholder="Detalhes adicionais..."></textarea>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div class="flex flex-col gap-2">
        <label for="amount" class="font-semibold text-gray-700 dark:text-gray-200">Valor</label>
        <p-inputNumber inputId="amount" formControlName="amount" mode="currency" currency="BRL" locale="pt-BR"
          placeholder="R$ 0,00" [style]="{ width: '100%' }" inputStyleClass="w-full">
        </p-inputNumber>
      </div>
      <div class="flex flex-col gap-2">
        <label for="date" class="font-semibold text-gray-700 dark:text-gray-200">Data</label>
        <p-datepicker inputId="date" formControlName="date" dateFormat="dd/mm/yy" [showIcon]="true" [appendTo]="'body'"
          [style]="{ width: '100%' }" inputStyleClass="w-full">
        </p-datepicker>
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <label for="account" class="font-semibold text-gray-700 dark:text-gray-200">Conta / Carteira</label>
      <p-select inputId="account" [options]="accounts()" formControlName="account" optionLabel="name"
        placeholder="Selecione a conta de origem" [style]="{ width: '100%' }" [appendTo]="'body'">
        <ng-template pTemplate="item" let-acc>
          <div class="flex flex-col">
            <span class="font-bold">{{ acc.name }}</span>
            <span class="text-xs text-gray-500 uppercase">{{
              acc.type | accountType
              }}</span>
          </div>
        </ng-template>
      </p-select>
    </div>

    <div class="flex flex-col gap-2">
      <label for="category" class="font-semibold text-gray-700 dark:text-gray-200">Categoria</label>
      <p-select inputId="category" [options]="filteredCategories()" formControlName="category"
        placeholder="Selecione uma categoria" [group]="true" [style]="{ width: '100%' }" [appendTo]="'body'"
        [emptyMessage]="'Nenhuma categoria deste tipo encontrada.'">
        <ng-template pTemplate="group" let-group>
          <div class="flex items-center gap-2">
            <span class="font-bold">{{ group.label }}</span>
          </div>
        </ng-template>

        <ng-template pTemplate="item" let-cat>
          <div class="flex items-center gap-2 ml-2">
            <i [class]="cat.icon" [style.color]="cat.color"></i>
            <span>{{ cat.label }}</span>
          </div>
        </ng-template>

        <ng-template pTemplate="selectedItem" let-cat>
          @if (cat) {
          <div class="flex items-center gap-2">
            <i [class]="cat.icon" [style.color]="cat.color"></i>
            <span>{{ cat.name }}</span>
          </div>
          }
        </ng-template>
      </p-select>
    </div>

    <div class="flex flex-col gap-2">
      <label for="payment" class="font-semibold text-gray-700 dark:text-gray-200">Pagamento</label>
      <p-select inputId="payment" [options]="paymentOptions" formControlName="payment_method" optionLabel="label"
        optionValue="value" placeholder="Selecione..." [style]="{ width: '100%' }" [appendTo]="'body'">
      </p-select>
    </div>

    <div class="flex items-center gap-2 mt-2">
      <p-checkbox formControlName="is_paid" [binary]="true" inputId="is_paid"></p-checkbox>
      <label for="is_paid" class="cursor-pointer font-semibold text-gray-700 dark:text-gray-200">Pago / Recebido</label>
    </div>

    @if (form.get('is_paid')?.value) {
    <div class="flex flex-col gap-2 mt-2">
      <label for="payment_date" class="font-semibold text-gray-700 dark:text-gray-200">Data do Pagamento</label>
      <p-datepicker inputId="payment_date" formControlName="payment_date" dateFormat="dd/mm/yy" [showIcon]="true"
        [appendTo]="'body'" [style]="{ width: '100%' }" inputStyleClass="w-full">
      </p-datepicker>
    </div>
    }

    <div class="flex justify-between mt-6">
      @if (editingId()) {
      <p-button label="Excluir" icon="pi pi-trash" severity="danger" [text]="true" [rounded]="true"
        (onClick)="confirmDelete()"></p-button>
      }
      <div class="flex gap-2 ml-auto">
        <p-button label="Cancelar" severity="secondary" (onClick)="visible.set(false)"></p-button>
        <p-button label="Salvar" icon="pi pi-check" type="submit" [disabled]="form.invalid"></p-button>
      </div>
    </div>
  </form>
</p-dialog>
